<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - DairyPro Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --primary-dark: #4338ca;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f9fafb;
        }
        
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        
        /* Enhanced sidebar styles */
        .sidebar {
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-link { 
            transition: all 0.3s ease; 
            border-radius: 8px;
            margin: 4px 0;
        }
        
        .sidebar-link.active, .sidebar-link:hover { 
            background-color: rgba(255, 255, 255, 0.15); 
            color: white;
            transform: translateX(4px);
        }
        
        .sidebar-link i { 
            margin-right: 0.75rem; 
            width: 20px;
            text-align: center;
        }
        
        .modal { display: none; }
        
        /* Card hover effects */
        .summary-card { 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .summary-card:hover { 
            transform: translateY(-6px); 
            box-shadow: 0 12px 25px -8px rgba(0, 0, 0, 0.15); 
        }
        
        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
        }
        
        .card-blue::before { background-color: var(--info); }
        .card-green::before { background-color: var(--secondary); }
        .card-red::before { background-color: var(--danger); }
        .card-purple::before { background-color: var(--primary); }
        
        /* Table enhancements */
        table { 
            border-collapse: separate; 
            border-spacing: 0; 
            border-radius: 10px;
            overflow: hidden;
        }
        
        th, td { 
            border-bottom: 1px solid #e5e7eb; 
            padding: 1rem;
        }
        
        th { 
            background-color: #f8fafc; 
            font-weight: 600;
            color: var(--dark);
        }
        
        tr:last-child td { border-bottom: none; }
        
        /* Button styles */
        .btn { 
            transition: all 0.2s ease; 
            border-radius: 8px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary { 
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover { 
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        .btn-success { 
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-success:hover { 
            background-color: #0da271;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-danger { 
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover { 
            background-color: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .btn-info { 
            background-color: var(--info);
            color: white;
        }
        
        .btn-info:hover { 
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        /* Input focus styles */
        .form-input {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            outline: none;
        }
        
        /* Section transitions */
        .content-section {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Header with gradient */
        .main-header {
            background: linear-gradient(90deg, white 0%, #f8fafc 100%);
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ensure canvas is responsive */
        #milkChart, #debitChart { 
            max-height: 400px; 
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar Navigation -->
        <div class="w-64 sidebar text-white flex flex-col fixed h-full z-10">
            <div class="px-6 py-5 border-b border-blue-700">
                <h2 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-cow mr-3 text-blue-200"></i> 
                    <span class="bg-gradient-to-r from-blue-100 to-blue-200 bg-clip-text text-transparent">DairyPro</span>
                </h2>
                <p class="text-blue-200 text-sm mt-1">Management System</p>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-1">
                <a href="index.html" class="sidebar-link flex items-center px-4 py-3">
                    <i class="fas fa-tachometer-alt"></i> 
                    <span>Dashboard</span>
                </a>
                <a href="farmers.html" class="sidebar-link flex items-center px-4 py-3">
                    <i class="fas fa-users"></i> 
                    <span>Farmers</span>
                </a>
                <a href="delivery.html" class="sidebar-link flex items-center px-4 py-3">
                    <i class="fas fa-truck"></i> 
                    <span>Record Delivery</span>
                </a>
                <a href="debit.html" class="sidebar-link flex items-center px-4 py-3">
                    <i class="fas fa-minus-circle"></i> 
                    <span>Record Debit</span>
                </a>
                <a href="payment.html" class="sidebar-link flex items-center px-4 py-3">
                    <i class="fas fa-money-bill-wave"></i> 
                    <span>Record Payment</span>
                </a>
                <a href="analytics.html" class="sidebar-link active flex items-center px-4 py-3">
                    <i class="fas fa-chart-line"></i> 
                    <span>Analytics</span>
                </a>
                <a href="transactions.html" class="sidebar-link flex items-center px-4 py-3">
                    <i class="fas fa-exchange-alt"></i> 
                    <span>Transactions</span>
                </a>
                <a href="reports.html" class="sidebar-link flex items-center px-4 py-3">
                    <i class="fas fa-file-alt"></i> 
                    <span>Reports</span>
                </a>
                <a href="profile.html" class="sidebar-link flex items-center px-4 py-3">
                    <i class="fas fa-building"></i> 
                    <span>Profile</span>
                </a>
                <a href="#" class="sidebar-link flex items-center px-4 py-3 mt-4" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> 
                    <span>Logout</span>
                </a>
            </nav>
            <div class="px-6 py-4 border-t border-blue-700 text-sm text-blue-200">
                <p>Â© 2025 DairyPro Management</p>
            </div>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden ml-64">
            <header class="main-header p-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-chart-line mr-3 text-indigo-500"></i> 
                        Analytics
                    </h1>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <button class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition">
                                <i class="fas fa-bell text-gray-600"></i>
                                <span class="notification-badge">3</span>
                            </button>
                        </div>
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white font-semibold">
                                A
                            </div>
                            <span class="ml-2 text-gray-700 font-medium">Admin</span>
                        </div>
                    </div>
                </div>
            </header>
            
            <main class="flex-1 overflow-x-hidden overflow-y-auto p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                    <i class="fas fa-chart-line mr-3 text-indigo-500"></i> 
                    Cooperative Analytics Dashboard
                </h2>
                
                <!-- Summary Cards -->
                <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="summary-card bg-white p-6 card-blue">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-gray-500 flex items-center">
                                    <i class="fas fa-users mr-2"></i> 
                                    Active Farmers
                                </h2>
                                <p class="text-3xl font-bold mt-2" id="analytics-farmerCount">0</p>
                            </div>
                            <div class="p-3 rounded-lg bg-blue-50 text-blue-500">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-card bg-white p-6 card-green">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-gray-500 flex items-center">
                                    <i class="fas fa-tint mr-2"></i> 
                                    Total Milk (L)
                                </h2>
                                <p class="text-3xl font-bold mt-2" id="analytics-totalMilk">0</p>
                            </div>
                            <div class="p-3 rounded-lg bg-green-50 text-green-500">
                                <i class="fas fa-tint text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-card bg-white p-6 card-red">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-gray-500 flex items-center">
                                    <i class="fas fa-minus-circle mr-2"></i> 
                                    Total Debits
                                </h2>
                                <p class="text-3xl font-bold mt-2" id="analytics-totalDebits">0 Rwf</p>
                            </div>
                            <div class="p-3 rounded-lg bg-red-50 text-red-500">
                                <i class="fas fa-minus-circle text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-card bg-white p-6 card-purple">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-gray-500 flex items-center">
                                    <i class="fas fa-dollar-sign mr-2"></i> 
                                    Total Revenue
                                </h2>
                                <p class="text-3xl font-bold mt-2" id="analytics-totalRevenue">0 Rwf</p>
                            </div>
                            <div class="p-3 rounded-lg bg-purple-50 text-purple-500">
                                <i class="fas fa-dollar-sign text-xl"></i>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Charts Section -->
                <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h2 class="font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-chart-line mr-2 text-indigo-500"></i> 
                            Milk Collection Trend (Last 7 Days)
                        </h2>
                        <canvas id="milkChart"></canvas>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h2 class="font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-chart-bar mr-2 text-indigo-500"></i> 
                            Monthly Cash Flow (Debits vs Payments)
                        </h2>
                        <canvas id="debitChart"></canvas>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let farmers = JSON.parse(localStorage.getItem('farmers')) || [];
        let milkDeliveries = JSON.parse(localStorage.getItem('milkDeliveries')) || [];
        let farmerDebits = JSON.parse(localStorage.getItem('farmerDebits')) || [];
        let farmerPayments = JSON.parse(localStorage.getItem('farmerPayments')) || []; 
        let settings = JSON.parse(localStorage.getItem('settings')) || { pricePerLitre: 300 };
        let companyProfile = JSON.parse(localStorage.getItem('companyProfile')) || {
            name: 'My Dairy Business',
            address: '123 Milk Lane, Farmtown',
            phone: '555-MILK-NOW',
            email: 'contact@mydairy.com'
        };

        // --- GLOBAL CHART INSTANCES ---
        let milkChartInstance = null;
        let debitChartInstance = null;
        
        // --- INITIALIZATION & DATA PERSISTENCE ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication
            if (localStorage.getItem('isAuthenticated') !== 'true') {
                window.location.href = 'login.html';
                return;
            }
            
            // Add sample data if empty
            if (farmers.length === 0) {
                initializeSampleData();
            }
            
            initAnalytics();
        });

        function initializeSampleData() {
            farmers = [
                { id: 1, name: 'John Musole', email: 'john.musole@example.com', phone: '078-010-1010' },
                { id: 2, name: 'Aline Zawadi', email: 'aline.zawadi@example.com', phone: '078-010-2020' }
            ];
            milkDeliveries = [
                { id: 1, farmerId: 1, litresMorning: 25, litresNight: 25, date: new Date(new Date().setDate(new Date().getDate() - 7)).toISOString().split('T')[0] },
                { id: 2, farmerId: 2, litresMorning: 40, litresNight: 35, date: new Date(new Date().setDate(new Date().getDate() - 6)).toISOString().split('T')[0] },
                { id: 3, farmerId: 1, litresMorning: 30, litresNight: 25, date: new Date(new Date().setDate(new Date().getDate() - 2)).toISOString().split('T')[0] },
                { id: 4, farmerId: 2, litresMorning: 50, litresNight: 50, date: new Date(new Date().setDate(new Date().getDate() - 1)).toISOString().split('T')[0] },
                { id: 5, farmerId: 1, litresMorning: 20, litresNight: 20, date: new Date().toISOString().split('T')[0] }
            ];
            farmerDebits = [
                { id: 1, farmerId: 1, type: 'supply', description: 'Salt for cows', amount: 25000, date: new Date(new Date().getFullYear(), new Date().getMonth(), 15).toISOString().split('T')[0] },
                { id: 2, farmerId: 2, type: 'loan', description: 'Cash advance', amount: 100000, date: new Date(new Date().getFullYear(), new Date().getMonth() - 1, 10).toISOString().split('T')[0] }
            ];
            farmerPayments = [
                { id: 1, farmerId: 1, type: 'payment', description: 'Partial month settlement', amount: 15000, date: new Date(new Date().getFullYear(), new Date().getMonth(), 20).toISOString().split('T')[0] }
            ];
            saveAllData();
        }
        
        function saveAllData() {
            localStorage.setItem('farmers', JSON.stringify(farmers));
            localStorage.setItem('milkDeliveries', JSON.stringify(milkDeliveries));
            localStorage.setItem('farmerDebits', JSON.stringify(farmerDebits));
            localStorage.setItem('farmerPayments', JSON.stringify(farmerPayments));
            localStorage.setItem('settings', JSON.stringify(settings));
            localStorage.setItem('companyProfile', JSON.stringify(companyProfile));
        }
        
        // --- UTILITIES ---
        function formatCurrency(amount) {
            const sign = amount < 0 ? '-' : '';
            const absAmount = Math.abs(amount);
            return `${sign}${new Intl.NumberFormat('en-US').format(absAmount)} Rwf`;
        }
        
        function formatLitres(litres) {
            return new Intl.NumberFormat('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(litres);
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full ${type === 'success' ? 'bg-green-500' : 'bg-blue-500'} text-white`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-info-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 10);
            
            // Remove after delay
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        function logout() {
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        }

        // --- ANALYTICS FUNCTIONS ---
        function initAnalytics() {
            renderAnalyticsDashboard();
        }

        function calculateAnalyticsData() {
            const totalLitresAllTime = milkDeliveries.reduce((sum, d) => sum + (d.litresMorning || 0) + (d.litresNight || 0), 0);
            const totalDebitsAllTime = farmerDebits.reduce((sum, d) => sum + d.amount, 0);
            const totalRevenue = totalLitresAllTime * settings.pricePerLitre;

            // Milk Trend (Last 7 Days)
            const dayLabels = [];
            const milkData = [];
            const milkByDate = {};
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                dayLabels.push(dayName);
                milkByDate[dateString] = 0;
            }

            milkDeliveries.forEach(d => {
                if (d.date in milkByDate) {
                    milkByDate[d.date] += (d.litresMorning || 0) + (d.litresNight || 0);
                }
            });
            
            dayLabels.forEach((_, index) => milkData.push(milkByDate[Object.keys(milkByDate)[index]] || 0));

            // Monthly Cash Flow (Debits vs Payments)
            const monthMap = {};
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const monthDate = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthKey = monthDate.toISOString().substring(0, 7);
                monthMap[monthKey] = { debit: 0, payment: 0, label: monthDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }) };
            }
            
            farmerDebits.forEach(d => {
                const monthKey = d.date.substring(0, 7);
                if (monthKey in monthMap) {
                    monthMap[monthKey].debit += d.amount;
                }
            });
            
            farmerPayments.forEach(p => {
                const monthKey = p.date.substring(0, 7);
                if (monthKey in monthMap) {
                    monthMap[monthKey].payment += p.amount;
                }
            });

            const monthlyLabels = Object.values(monthMap).map(m => m.label);
            const monthlyDebits = Object.values(monthMap).map(m => m.debit);
            const monthlyPayments = Object.values(monthMap).map(m => m.payment);

            return {
                farmerCount: farmers.length,
                totalMilk: totalLitresAllTime,
                totalDebits: totalDebitsAllTime,
                totalRevenue: totalRevenue,
                
                milkTrendLabels: dayLabels,
                milkTrendData: milkData,
                
                cashFlowLabels: monthlyLabels,
                monthlyDebits: monthlyDebits,
                monthlyPayments: monthlyPayments
            };
        }
        
        function renderAnalyticsDashboard() {
            const data = calculateAnalyticsData();

            // Update Summary Cards
            document.getElementById('analytics-farmerCount').textContent = data.farmerCount;
            document.getElementById('analytics-totalMilk').textContent = formatLitres(data.totalMilk);
            document.getElementById('analytics-totalDebits').textContent = formatCurrency(data.totalDebits);
            document.getElementById('analytics-totalRevenue').textContent = formatCurrency(data.totalRevenue);

            // Milk Trend Chart (Line Chart)
            const milkCtx = document.getElementById('milkChart');
            if (!milkCtx) return;
            
            const milkCanvasCtx = milkCtx.getContext('2d');
            
            if (milkChartInstance) {
                milkChartInstance.destroy();
            }
            
            milkChartInstance = new Chart(milkCanvasCtx, {
                type: 'line',
                data: {
                    labels: data.milkTrendLabels,
                    datasets: [{
                        label: 'Litres Collected',
                        data: data.milkTrendData,
                        borderColor: '#4a90e2',
                        backgroundColor: 'rgba(74,144,226,0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true, position: 'top' } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Litres (L)' } } }
                }
            });

            // Debit vs Payments Chart (Bar Chart)
            const debitCtx = document.getElementById('debitChart');
            if (!debitCtx) return;
            
            const debitCanvasCtx = debitCtx.getContext('2d');
            
            if (debitChartInstance) {
                debitChartInstance.destroy();
            }
            
            debitChartInstance = new Chart(debitCanvasCtx, {
                type: 'bar',
                data: {
                    labels: data.cashFlowLabels,
                    datasets: [
                        {
                            label: 'Farmer Debits/Loans',
                            data: data.monthlyDebits,
                            backgroundColor: '#ff7f50'
                        },
                        {
                            label: 'Payments to Farmer',
                            data: data.monthlyPayments,
                            backgroundColor: '#4a90e2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Amount (Rwf)' } } }
                }
            });
        }
    </script>
</body>
</html>